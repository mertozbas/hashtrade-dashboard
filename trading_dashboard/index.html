<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trading Agent Dashboard (Prototype)</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f1a2e; --panel2:#0c1629; --text:#e7eefc; --muted:#9bb0d1;
      --line:#203152; --accent:#6aa6ff; --good:#2ee59d; --bad:#ff5c7a; --warn:#ffd36a;
      --shadow: 0 8px 30px rgba(0,0,0,.35);
      --radius:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--sans); color:var(--text); background:
        radial-gradient(1200px 600px at 20% 0%, rgba(106,166,255,.18), transparent 60%),
        radial-gradient(900px 500px at 100% 20%, rgba(46,229,157,.10), transparent 60%),
        var(--bg);
      overflow:hidden;
    }
    a{color:var(--accent)}
    .app{
      height:100%;
      display:grid;
      grid-template-columns: 420px 1fr 420px;
      grid-template-rows: 64px 1fr 86px;
      gap:12px;
      padding:12px;
    }
    header{
      grid-column:1 / 4;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .brand{display:flex; gap:10px; align-items:center;}
    .logo{
      width:34px;height:34px;border-radius:10px;
      background:conic-gradient(from 180deg, var(--accent), rgba(46,229,157,.9), rgba(255,92,122,.9), var(--accent));
      filter:saturate(1.1);
    }
    .brand h1{font-size:14px; margin:0; letter-spacing:.2px}
    .brand .sub{font-size:12px; color:var(--muted)}

    .top-left{
      display:flex; gap:10px; align-items:center;
      padding:8px 10px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      border-radius:12px;
    }
    .pill{font-family:var(--mono); font-size:12px; color:var(--muted)}
    .balance{
      font-family:var(--mono);
      font-size:14px;
      color:var(--text);
    }
    .delta.good{color:var(--good)}
    .delta.bad{color:var(--bad)}

    .panel{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .panel .hd{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.12);
    }
    .panel .hd h2{font-size:13px;margin:0;color:var(--text)}
    .panel .hd .meta{font-size:12px;color:var(--muted); font-family:var(--mono)}
    .panel .bd{padding:12px; overflow:auto; min-height:0;}

    /* Left graph panel */
    #graphWrap{height:100%; display:flex; flex-direction:column; gap:10px;}
    .graphCanvasWrap{
      flex:1;
      border:1px solid var(--line);
      background:var(--panel2);
      border-radius:12px;
      overflow:hidden;
      position:relative;
    }
    canvas{display:block; width:100%; height:100%}
    .graphLegend{
      display:flex; gap:10px; flex-wrap:wrap;
      font-size:12px; color:var(--muted);
    }
    .dot{width:8px;height:8px;border-radius:99px;display:inline-block;margin-right:6px;}

    /* Center history panel */
    .timeline{display:flex; flex-direction:column; gap:10px;}
    .event{
      border:1px solid rgba(32,49,82,.9);
      background:rgba(15,26,46,.7);
      border-radius:12px;
      padding:10px 10px;
    }
    .event .row{display:flex; justify-content:space-between; gap:10px;}
    .event .ts{font-family:var(--mono); font-size:11px; color:var(--muted)}
    .event .tag{font-family:var(--mono); font-size:11px; color:var(--muted)}
    .event .msg{margin-top:6px; font-size:13px; line-height:1.35}
    .event .mini{margin-top:6px; display:flex; gap:8px; flex-wrap:wrap; font-family:var(--mono); font-size:11px; color:var(--muted)}
    .badge{padding:2px 8px; border-radius:999px; border:1px solid var(--line); background:rgba(0,0,0,.15)}
    .badge.good{border-color:rgba(46,229,157,.35); color:rgba(46,229,157,.95)}
    .badge.bad{border-color:rgba(255,92,122,.35); color:rgba(255,92,122,.95)}
    .badge.warn{border-color:rgba(255,211,106,.35); color:rgba(255,211,106,.95)}

    /* Right agent/chat panel */
    .chat{display:flex; flex-direction:column; gap:10px;}
    .bubble{
      max-width:92%;
      padding:10px 10px;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(15,26,46,.75);
      box-shadow:0 10px 25px rgba(0,0,0,.25);
      font-size:13px;
      line-height:1.35;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .bubble.user{margin-left:auto; border-color:rgba(106,166,255,.35); background:rgba(106,166,255,.10)}
    .bubble.agent{margin-right:auto; border-color:rgba(46,229,157,.30); background:rgba(46,229,157,.08)}
    .bubble.tool{margin-right:auto; border-color:rgba(255,211,106,.30); background:rgba(255,211,106,.08); font-family:var(--mono)}

    /* Bottom controls */
    footer{
      grid-column:1 / 4;
      display:flex;
      gap:12px;
      align-items:center;
      padding:10px 12px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      min-height:0;
    }
    .controls{display:flex; align-items:center; gap:10px;}
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-size:12px;
    }
    .btn:hover{border-color:rgba(106,166,255,.45)}
    .btn.primary{border-color:rgba(106,166,255,.55); background:rgba(106,166,255,.12)}
    .btn.danger{border-color:rgba(255,92,122,.45); background:rgba(255,92,122,.10)}

    .sliderWrap{display:flex; align-items:center; gap:10px; flex:1;}
    input[type="range"]{width:100%}
    .timeReadout{font-family:var(--mono); font-size:12px; color:var(--muted); min-width:250px; text-align:right}

    .chatInputWrap{display:flex; align-items:center; gap:10px; flex:1.2;}
    .chatInput{
      flex:1;
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      color:var(--text);
      font-size:13px;
      outline:none;
    }
    .chatInput:focus{border-color:rgba(106,166,255,.55)}

    .tiny{font-size:11px;color:var(--muted)}

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
    }
    .modal{
      width:min(860px, 96vw);
      background:rgba(15,26,46,.96);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modal .hd{padding:12px 14px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center}
    .modal .bd{padding:14px}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    .field{width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(0,0,0,.18); color:var(--text)}
    .field:focus{outline:none; border-color:rgba(106,166,255,.55)}
    .warnBox{padding:10px 12px; border-radius:12px; border:1px solid rgba(255,211,106,.35); background:rgba(255,211,106,.08); color:var(--muted); font-size:12px}

    @media (max-width: 1200px){
      body{overflow:auto}
      .app{height:auto; grid-template-columns:1fr; grid-template-rows:auto;}
      header, footer{grid-column:1}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Trading Agent Dashboard <span class="sub">(front-end prototype)</span></h1>
          <div class="sub">Stateful timeline + chart overlay + agent chat</div>
        </div>
      </div>

      <div class="top-left" title="Balance snapshot at selected time">
        <div>
          <div class="pill">BALANCE</div>
          <div class="balance"><span id="balUsd">$0.00</span> <span class="pill">USD</span></div>
        </div>
        <div>
          <div class="pill">USDT</div>
          <div class="balance"><span id="balUsdt">0.00</span></div>
          <div class="pill"><span id="balDelta" class="delta good">+0.00</span> <span class="pill">Δ</span></div>
        </div>
        <button class="btn" id="btnKeys">API Keys</button>
      </div>
    </header>

    <!-- Left: chart + trades overlay -->
    <section class="panel" style="grid-column:1; grid-row:2;">
      <div class="hd">
        <h2>Market Graph</h2>
        <div class="meta"><span id="symbolLbl">ETH/USDT</span> • <span id="tfLbl">1m</span></div>
      </div>
      <div class="bd" id="graphWrap">
        <div class="graphLegend">
          <span><span class="dot" style="background: var(--accent)"></span>price</span>
          <span><span class="dot" style="background: var(--good)"></span>buy</span>
          <span><span class="dot" style="background: var(--bad)"></span>sell</span>
          <span><span class="dot" style="background: var(--warn)"></span>tool</span>
        </div>
        <div class="graphCanvasWrap">
          <canvas id="chart"></canvas>
        </div>
        <div class="tiny">Prototype chart (mock candles). Later: wire to CCXT OHLCV + your open trades.</div>
      </div>
    </section>

    <!-- Center: action history -->
    <section class="panel" style="grid-column:2; grid-row:2;">
      <div class="hd">
        <h2>History of Actions</h2>
        <div class="meta">events: <span id="eventCount">0</span></div>
      </div>
      <div class="bd">
        <div class="timeline" id="timeline"></div>
      </div>
    </section>

    <!-- Right: chat / agent screen -->
    <section class="panel" style="grid-column:3; grid-row:2;">
      <div class="hd">
        <h2>Agent Screen</h2>
        <div class="meta">chat: <span id="chatCount">0</span></div>
      </div>
      <div class="bd">
        <div class="chat" id="chat"></div>
      </div>
    </section>

    <footer>
      <div class="controls">
        <button class="btn" id="btnPrev">⟵</button>
        <button class="btn primary" id="btnPlay">Play</button>
        <button class="btn" id="btnNext">⟶</button>
        <button class="btn danger" id="btnReset">Reset</button>
      </div>

      <div class="sliderWrap">
        <input type="range" id="timeSlider" min="0" max="0" step="1" value="0" />
        <div class="timeReadout" id="timeReadout">t=0</div>
      </div>

      <div class="chatInputWrap">
        <input class="chatInput" id="chatInput" placeholder='Try: "5 dollars eth" or "buy 0.01 eth"' />
        <button class="btn primary" id="btnSend">Send</button>
      </div>
    </footer>
  </div>

  <!-- API Keys Modal -->
  <div class="modalBack" id="modalBack" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="hd">
        <div style="font-weight:600">API Keys (client-side prototype)</div>
        <button class="btn" id="btnCloseKeys">Close</button>
      </div>
      <div class="bd">
        <div class="warnBox">
          This is a front-end-only prototype. Do NOT paste real exchange keys in production.
          In production: store keys server-side or use a signed session token; never keep raw secrets in the browser.
        </div>
        <div style="height:12px"></div>
        <div class="grid2">
          <div>
            <label>Exchange</label>
            <input class="field" id="kExchange" value="bybit" />
          </div>
          <div>
            <label>Environment</label>
            <input class="field" id="kEnv" value="mainnet" />
          </div>
          <div>
            <label>API Key</label>
            <input class="field" id="kKey" placeholder="BYBIT_API_KEY" />
          </div>
          <div>
            <label>API Secret</label>
            <input class="field" id="kSecret" placeholder="BYBIT_API_SECRET" />
          </div>
        </div>
        <div style="height:12px"></div>
        <button class="btn primary" id="btnSaveKeys">Save (localStorage)</button>
        <span class="tiny" id="keysStatus" style="margin-left:10px"></span>
      </div>
    </div>
  </div>

  <script>
    // -----------------------------
    // State model
    // -----------------------------
    const state = {
      symbol: 'ETH/USDT',
      tf: '1m',
      playing: false,
      playTimer: null,
      nowIndex: 0,
      timeline: [],   // ordered events
      snapshots: [],  // derived snapshots per event index
      keys: {exchange:'bybit', env:'mainnet', key:'', secret:''},
      // mock market series for the graph
      market: { points: [] },
      // balances
      balance: { usd: 76.44, usdt: 76.44 },
    };

    // Each event has: {id, ts, type, message, data}
    // type: user | agent | tool | order | balance

    function isoNow(){ return new Date().toISOString(); }
    function fmtMoney(x){ return (Math.round(x*100)/100).toFixed(2); }

    // -----------------------------
    // Minimal “agent” simulation
    // (Replace with real API calls: CCXT via your backend)
    // -----------------------------
    function parseUserIntent(text){
      // naive parse: "5 dollars eth" => market buy ETH for $5
      const t = text.toLowerCase().trim();
      const m1 = t.match(/(\d+(?:\.\d+)?)\s*(?:\$|usd|dollars?)\s*(btc|eth|sol|link|doge)/i);
      if (m1){
        return { kind:'market_buy_quote', quoteUsd: parseFloat(m1[1]), base: m1[2].toUpperCase() };
      }
      const m2 = t.match(/(buy|sell)\s*(\d+(?:\.\d+)?)\s*(btc|eth|sol|link|doge)/i);
      if (m2){
        return { kind:'market', side:m2[1].toLowerCase(), amountBase: parseFloat(m2[2]), base:m2[3].toUpperCase() };
      }
      return { kind:'unknown' };
    }

    function agentPlan(intent){
      if (intent.kind === 'market_buy_quote'){
        return {
          speech: `Got it. I'll buy ${intent.base} worth $${intent.quoteUsd.toFixed(2)} using create_order (market).`,
          toolCall: { method:'create_order', params:{ symbol:`${intent.base}/USDT`, type:'market', side:'buy', quoteOrderQty:intent.quoteUsd } },
        };
      }
      if (intent.kind === 'market'){
        return {
          speech: `Ok. I'll ${intent.side} ${intent.amountBase} ${intent.base} using create_order (market).`,
          toolCall: { method:'create_order', params:{ symbol:`${intent.base}/USDT`, type:'market', side:intent.side, amount:intent.amountBase } },
        };
      }
      return { speech: "I couldn't parse that. Try: '5 dollars eth' or 'buy 0.01 eth'.", toolCall: null };
    }

    // mock price lookup (replace with ccxt fetchTicker)
    function getMockPrice(base){
      const last = state.market.points.at(-1)?.y ?? 2200;
      if (base==='ETH') return last;
      if (base==='BTC') return last*40;
      return last/10;
    }

    function executeMockOrder(toolCall){
      // returns {fills, newBalance, tradeMarker}
      const p = toolCall.params;
      const base = p.symbol.split('/')[0];
      const price = getMockPrice(base);
      let spent = 0;
      let qty = 0;
      if (p.side==='buy'){
        if (p.quoteOrderQty){
          spent = p.quoteOrderQty;
          qty = spent / price;
        } else {
          qty = p.amount;
          spent = qty * price;
        }
        state.balance.usdt = Math.max(0, state.balance.usdt - spent);
      } else {
        // sell: add proceeds (mock)
        qty = p.amount;
        spent = -(qty * price);
        state.balance.usdt = state.balance.usdt + (qty * price);
      }
      state.balance.usd = state.balance.usdt; // simplified

      return {
        fills: [{ price, qty, cost: Math.abs(spent), side: p.side, symbol: p.symbol }],
        balance: { ...state.balance },
        trade: { ts: isoNow(), side:p.side, symbol:p.symbol, price, qty }
      };
    }

    // -----------------------------
    // Timeline + snapshots (time travel)
    // -----------------------------
    function addEvent(type, message, data={}){
      const e = { id: crypto.randomUUID(), ts: isoNow(), type, message, data };
      state.timeline.push(e);
      deriveSnapshots();
      setNowIndex(state.timeline.length - 1);
      render();
    }

    function deriveSnapshots(){
      // Build snapshots incrementally from scratch (simple)
      const snaps = [];
      let bal = { usd: 76.44, usdt: 76.44 };
      const trades = [];
      for (let i=0;i<state.timeline.length;i++){
        const e = state.timeline[i];
        if (e.type==='balance' && e.data?.balance){ bal = {...e.data.balance}; }
        if (e.type==='order' && e.data?.trade){ trades.push(e.data.trade); }
        snaps.push({
          i,
          ts: e.ts,
          balance: {...bal},
          trades: trades.slice(),
          timeline: state.timeline.slice(0, i+1)
        });
      }
      state.snapshots = snaps;
      const slider = document.getElementById('timeSlider');
      slider.max = Math.max(0, state.snapshots.length - 1);
      slider.value = Math.min(parseInt(slider.value||'0',10), slider.max);
    }

    function setNowIndex(i){
      state.nowIndex = Math.max(0, Math.min(i, state.snapshots.length-1));
      document.getElementById('timeSlider').value = String(state.nowIndex);
      render();
    }

    // -----------------------------
    // Rendering
    // -----------------------------
    function render(){
      const snap = state.snapshots[state.nowIndex] || {balance: state.balance, trades:[], timeline:[]};

      // header balance
      document.getElementById('balUsd').textContent = `$${fmtMoney(snap.balance.usd)}`;
      document.getElementById('balUsdt').textContent = fmtMoney(snap.balance.usdt);
      const delta = snap.balance.usdt - 76.44;
      const dEl = document.getElementById('balDelta');
      dEl.textContent = (delta>=0?'+':'') + fmtMoney(delta);
      dEl.className = 'delta ' + (delta>=0?'good':'bad');

      document.getElementById('symbolLbl').textContent = state.symbol;
      document.getElementById('tfLbl').textContent = state.tf;

      // timeline events (center)
      const tl = document.getElementById('timeline');
      tl.innerHTML = '';
      for (const e of snap.timeline){
        const div = document.createElement('div');
        div.className = 'event';
        const badge = (t)=>{
          if (t==='order') return '<span class="badge good">order</span>';
          if (t==='tool') return '<span class="badge warn">tool</span>';
          if (t==='agent') return '<span class="badge">agent</span>';
          if (t==='user') return '<span class="badge">user</span>';
          if (t==='balance') return '<span class="badge">balance</span>';
          return '<span class="badge">event</span>';
        };
        div.innerHTML = `
          <div class="row">
            <div class="tag">${badge(e.type)} <span class="pill">${e.type}</span></div>
            <div class="ts">${e.ts}</div>
          </div>
          <div class="msg">${escapeHtml(e.message)}</div>
          <div class="mini">
            ${e.data?.symbol?`<span class="badge">${escapeHtml(e.data.symbol)}</span>`:''}
            ${e.data?.side?`<span class="badge">${escapeHtml(e.data.side)}</span>`:''}
            ${e.data?.price?`<span class="badge">px ${fmtMoney(e.data.price)}</span>`:''}
          </div>
        `;
        tl.appendChild(div);
      }
      document.getElementById('eventCount').textContent = String(snap.timeline.length);

      // chat (right): only user+agent+tool messages
      const chat = document.getElementById('chat');
      chat.innerHTML='';
      const chatEvents = snap.timeline.filter(e => ['user','agent','tool'].includes(e.type));
      for (const e of chatEvents){
        const b = document.createElement('div');
        b.className = 'bubble ' + (e.type==='user'?'user':(e.type==='agent'?'agent':'tool'));
        b.textContent = `[${e.ts}] ${e.type.toUpperCase()}
` + e.message;
        chat.appendChild(b);
      }
      document.getElementById('chatCount').textContent = String(chatEvents.length);
      chat.scrollTop = chat.scrollHeight;

      // time readout
      const tr = document.getElementById('timeReadout');
      if (state.snapshots.length){
        tr.textContent = `index ${state.nowIndex}/${state.snapshots.length-1} • ${snap.ts}`;
      } else {
        tr.textContent = 't=0';
      }

      drawChart(snap);
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
    }

    // -----------------------------
    // Chart drawing (mock)
    // -----------------------------
    function seedMarket(){
      // 180 points of random-walk
      const pts = [];
      let y = 2200;
      const now = Date.now();
      for (let i=0;i<180;i++){
        y += (Math.random()-0.5) * 10;
        pts.push({ x: now - (180-i)*60_000, y });
      }
      state.market.points = pts;
    }

    function drawChart(snap){
      const canvas = document.getElementById('chart');
      const wrap = canvas.parentElement;
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const w = wrap.clientWidth;
      const h = wrap.clientHeight;
      canvas.width = Math.floor(w*dpr);
      canvas.height = Math.floor(h*dpr);
      const ctx = canvas.getContext('2d');
      ctx.scale(dpr,dpr);

      // background
      ctx.clearRect(0,0,w,h);
      ctx.fillStyle = 'rgba(0,0,0,0.12)';
      ctx.fillRect(0,0,w,h);

      // grid
      ctx.strokeStyle = 'rgba(32,49,82,0.7)';
      ctx.lineWidth = 1;
      for (let i=0;i<=6;i++){
        const yy = (h/6)*i;
        ctx.beginPath(); ctx.moveTo(0,yy); ctx.lineTo(w,yy); ctx.stroke();
      }
      for (let i=0;i<=8;i++){
        const xx = (w/8)*i;
        ctx.beginPath(); ctx.moveTo(xx,0); ctx.lineTo(xx,h); ctx.stroke();
      }

      const pts = state.market.points;
      if (!pts.length) return;
      const minY = Math.min(...pts.map(p=>p.y));
      const maxY = Math.max(...pts.map(p=>p.y));
      const pad = (maxY-minY)*0.1 || 1;
      const lo = minY - pad, hi = maxY + pad;

      const x0 = pts[0].x;
      const x1 = pts[pts.length-1].x;
      const xScale = (t)=> ( (t-x0) / (x1-x0) ) * (w-20) + 10;
      const yScale = (v)=> h - ( (v-lo)/(hi-lo) )*(h-20) - 10;

      // price line
      ctx.strokeStyle = 'rgba(106,166,255,0.95)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      pts.forEach((p, i)=>{
        const x=xScale(p.x), y=yScale(p.y);
        if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();

      // trade markers
      for (const t of snap.trades){
        const px = t.price;
        const x = xScale(Date.parse(t.ts));
        const y = yScale(px);
        ctx.fillStyle = t.side==='buy' ? 'rgba(46,229,157,0.95)' : 'rgba(255,92,122,0.95)';
        ctx.strokeStyle = 'rgba(0,0,0,0.4)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(x, y, 6, 0, Math.PI*2);
        ctx.fill();
        ctx.stroke();
      }

      // label
      ctx.fillStyle = 'rgba(231,238,252,0.9)';
      ctx.font = '12px ' + getComputedStyle(document.body).fontFamily;
      ctx.fillText(`Last: ${fmtMoney(pts.at(-1).y)} (mock)`, 12, 18);
    }

    // -----------------------------
    // UI actions
    // -----------------------------
    function onSend(){
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      if (!text) return;
      input.value='';

      addEvent('user', text);

      const intent = parseUserIntent(text);
      const plan = agentPlan(intent);

      // agent speaks
      addEvent('agent', plan.speech);

      if (!plan.toolCall){
        return;
      }

      // tool call
      addEvent('tool', `ccxt.${plan.toolCall.method}(${JSON.stringify(plan.toolCall.params)})`, { symbol: plan.toolCall.params.symbol, side: plan.toolCall.params.side });

      // execute mock order
      const res = executeMockOrder(plan.toolCall);
      const fill = res.fills[0];

      addEvent('order', `Order filled: ${fill.side.toUpperCase()} ${fill.qty.toFixed(6)} @ ${fmtMoney(fill.price)} (${fill.symbol})`, {
        symbol: fill.symbol,
        side: fill.side,
        price: fill.price,
        trade: res.trade,
      });

      addEvent('balance', `Balance updated: USDT ${fmtMoney(res.balance.usdt)}`, { balance: res.balance });
    }

    function togglePlay(){
      state.playing = !state.playing;
      const btn = document.getElementById('btnPlay');
      btn.textContent = state.playing ? 'Pause' : 'Play';
      if (state.playing){
        state.playTimer = setInterval(()=>{
          if (!state.snapshots.length) return;
          if (state.nowIndex >= state.snapshots.length-1){
            state.playing = false;
            btn.textContent = 'Play';
            clearInterval(state.playTimer);
            return;
          }
          setNowIndex(state.nowIndex+1);
        }, 600);
      } else {
        clearInterval(state.playTimer);
      }
    }

    function resetAll(){
      state.timeline = [];
      state.snapshots = [];
      state.balance = { usd: 76.44, usdt: 76.44 };
      deriveSnapshots();
      setNowIndex(0);
      render();
    }

    // Modal handlers
    function openKeys(){
      document.getElementById('modalBack').style.display='flex';
      loadKeysToFields();
    }
    function closeKeys(){
      document.getElementById('modalBack').style.display='none';
    }
    function loadKeysToFields(){
      const k = loadKeys();
      document.getElementById('kExchange').value = k.exchange || 'bybit';
      document.getElementById('kEnv').value = k.env || 'mainnet';
      document.getElementById('kKey').value = k.key || '';
      document.getElementById('kSecret').value = k.secret || '';
      document.getElementById('keysStatus').textContent = k.key ? 'Loaded from localStorage' : 'Not set';
    }
    function saveKeysFromFields(){
      const k = {
        exchange: document.getElementById('kExchange').value.trim(),
        env: document.getElementById('kEnv').value.trim(),
        key: document.getElementById('kKey').value.trim(),
        secret: document.getElementById('kSecret').value.trim(),
      };
      localStorage.setItem('trading_dashboard_keys', JSON.stringify(k));
      state.keys = k;
      document.getElementById('keysStatus').textContent = 'Saved to localStorage';
      setTimeout(()=>document.getElementById('keysStatus').textContent='', 1200);
    }
    function loadKeys(){
      try{
        const raw = localStorage.getItem('trading_dashboard_keys');
        if (!raw) return state.keys;
        return JSON.parse(raw);
      }catch{ return state.keys; }
    }

    // Wire events
    window.addEventListener('resize', ()=>render());
    document.getElementById('btnSend').addEventListener('click', onSend);
    document.getElementById('chatInput').addEventListener('keydown', (e)=>{
      if (e.key==='Enter') onSend();
    });
    document.getElementById('btnPlay').addEventListener('click', togglePlay);
    document.getElementById('btnPrev').addEventListener('click', ()=>setNowIndex(state.nowIndex-1));
    document.getElementById('btnNext').addEventListener('click', ()=>setNowIndex(state.nowIndex+1));
    document.getElementById('btnReset').addEventListener('click', resetAll);
    document.getElementById('timeSlider').addEventListener('input', (e)=>setNowIndex(parseInt(e.target.value,10)));

    document.getElementById('btnKeys').addEventListener('click', openKeys);
    document.getElementById('btnCloseKeys').addEventListener('click', closeKeys);
    document.getElementById('modalBack').addEventListener('click', (e)=>{ if (e.target.id==='modalBack') closeKeys(); });
    document.getElementById('btnSaveKeys').addEventListener('click', saveKeysFromFields);

    // init
    state.keys = loadKeys();
    seedMarket();
    // pre-populate with a demo interaction
    addEvent('agent', 'Dashboard ready. Send an instruction like: "5 dollars eth".');
    addEvent('balance', 'Initial balance loaded.', { balance: { usd: state.balance.usd, usdt: state.balance.usdt } });

    // ensure slider
    deriveSnapshots();
    render();
  </script>
</body>
</html>
